# Личный домен в Яндекс Облаке и его проксирование

Быстрый старт («Quick Start») - сервис, который поможет создать репозиторий и привязать его к внешнему сервису Diplodoc, после чего станет доступна базовая документация, предзаполненная командой Diplodoc.

1. Переходим в [быстрый старт](https://diplodoc.com/quickstart/).
1. Авторизуемся в Github.

  {% note warning %}

  Если сервис выдаст ошибку «Could not get github state back» - вернитесь на страницу [быстрого старта](https://diplodoc.com/quickstart/).

  {% endnote %}

1. В шаге №2 нажмите **Создать** и создайте репозиторий в Github. В результате будет создан проект с именем «diplodoc-example».
1. В шаге №3 нажмите **Создать** и создайте проект в Diplodoc.
1. Готово. В результате успешного выполнения пошаговой инструкции вы получите сообщение:
  
  ```
  Ключи от каталога с документацией в S3.
  Идентификатор ключа:
  Здесь-будет-указан-идентификатор-ключа
  Секретный ключ:
  Здесь-будет-указан-секретный-ключ

  Сохраните идентификатор и ключ. После закрытия диалога значение ключа будет недоступно. Ключ будет добавлен в созданный репозиторий автоматически.
  ```

  {% note info %}

  Дождитесь этапа завершения релиза, проект будет доступен по ссылке.

  {% endnote %}

Для привязки домена к Яндекс Облаку:

1. Зарегистрируйте домен (в этом нам поможет любой [доменный регистратор](https://yandex.ru/search/?text=доменнный+регистратор)).
1. Авторизуйтесь или зарегистрируйтесь в [Яндекс Облаке](https://yandex.cloud/).

  {% note warning %}

  На странице [Биллинг](https://billing.yandex.cloud/accounts) убедитесь, что у вас подключен [платежный аккаунт](https://yandex.cloud/ru/docs/billing/concepts/billing-account), и находится в статусе `ACTIVE` или `TRIAL_ACTIVE`. Если платежного аккаунта нет, [создайте его](https://yandex.cloud/ru/docs/billing/quickstart/#create_billing_account).

  {% endnote %}

1. Перейдите в [консоль](https://console.yandex.cloud/folders/).
1. Откройте **Все сервисы** → **API Gateway**.
    
    {% note info %}

    API Gateway - упрощенный сервер в Яндекс Облаке, который позволяет обслуживать внешние запросы. Настраивается с помощью OpenAPI спецификации.

    {% endnote %}

1. Нажмите кнопку **Создать API-шлюз**.

1. Заполните поле **Имя\*** и описание.

1. В поле **Сеть** выберите `default` или свой вариант.

1. Заполните поле **Спецификация**, используя шаблон:

  {% cut "Спецификация OpenAPI" %}

    ```
    openapi: 3.0.0
    info:
      title: Proxy Example
      version: 1.0.0
    servers:
    - url: https://d5dj3947rd2qu5g1lbak.apigw.yandexcloud.net
    - url: домен-на-который-необходимо-спроксировать-документацию
    paths:
      /путь/{path+}:
        get:
          x-yc-apigateway-integration:
            headers:
              x-real-host: здесь-должен-быть-домен
              x-docs-proxy-base: в-каком-каталоге-размещаться
              x-docs-project-name: diplodoc-platform--docs
            http_method: get
            query:
              '*': '*'
            type: http
            url: https://diplodoc-platform--docs.viewer.diplodoc.com/{path}
          parameters:
            - name: path
              in: path
              required: false
              schema:
                type: string
    ```

  {% endcut %}

  #|
  || Параметр | Описание параметра ||
  || `servers:` | Содержит следующие вложенные параметры:
  - первый `url` параметр — оставьте по умолчанию,
  - второй `url`параметр — укажите свой домен. ||
  || `paths:` | Содержит правило и позволяет настраивать путь с помощью вложенного параметра `/путь/{path+}:` — указывает на каком урле должна располагаться документация. ||
  || `get` | Вложенное в `paths:` правило, которое объясняет как путь должен обрабатываться. В шаблоне правило обрабатывает все get-запросы. ||
  || `headers` | Параметр содержит служебные заголовки. ||
  |#

 {% note warning %}

  Если нужно размещаться в корне домена, замените ключ параметра `x-docs-proxy-base` на `' '`, а также у параметра `paths` уберите `/путь`, чтобы осталось `/{path+}:`

  {% endnote %}

1. Нажмите **Создать**.
1. Привяжите платежный аккаунт, если это необходимо, для этого нажмите кнопку **Привязать**.
1. Готово. В результате должен появиться API-шлюз со статусом `active`.

\* Поля со звездочкой обязательны для заполнения.

На данном этапе домен еще не подключен. Перед подключением домена к Яндекс Облаку, нужно [создать новый или загрузить личный сертификат](#cert-creating).

### Создание сертификата {#cert-creating}

Для завершения привязки домена к Яндекс Облаку нужно указать сертификат и подтвердить, что вы — владелец домена:

1. Перейдите в [консоль](https://console.yandex.cloud/folders/).
1. Откройте **Все сервисы** → **Certificate Manager**.
1. Нажмите **Создать сертификат**.
1. В открывшейся странице нажмите **Добавить сертификат**.
1. Выберите в выпадающем меню **Сертификат от Let's Encrypt**.

{% note info %}

Если у вас уже есть сертификат, который зарегистрирован во внешнем сервисе, вы можете использовать его, для этого в выпадающем меню выберите **Пользовательский сертификат**.

{% endnote %}

1. Заполните поле **Имя\*** и описание.
1. Укажите **Домены\***, для которых необходимо добавить сертификат.
1. Выберите в поле **Тип проверки** - DNS.
1. Готово. Созданный сертификат будет ожидать подтверждения со статусом `Validating`.
1. [Подтвердите](#cert-validating), что вы являетесь владельцем домена.

\* Поля со звездочкой обязательны для заполнения.

### Подтверждение сертификата {#cert-validating}

1. Перейдите в [консоль](https://console.yandex.cloud/folders/).
1. Откройте **Все сервисы** → **Certificate Manager**.
1. Выберите созданный или добавленный сертификат.
1. Пройдите проверку прав на домен, используя один из способов.
1. Готово. Права на владение доменов подтверждены.

### Подключение домена

1. Откройте **Все сервисы** → **API Gateway**.
1. Выберите созданный API-шлюз.
1. Нажмите в левом меню **домены**.
1. Нажмите **Подключить**.
1. Выберите созданный сертификат.
1. Укажите домен.
1. Нажмите **Подключить**.
1. Готово. Домен подключен, проксирование на личный домен работает.
